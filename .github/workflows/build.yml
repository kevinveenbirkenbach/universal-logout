name: Build & Publish Docker Image

on:
  workflow_call:

jobs:
  build:
    name: Build and push image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image name
        id: image
        run: |
          set -euo pipefail
          owner="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          repo="$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          echo "image=ghcr.io/${owner}/${repo}" >> "${GITHUB_OUTPUT}"

      - name: Detect tag for current commit
        id: version
        run: |
          set -euo pipefail
          tag="$(git tag --points-at HEAD | sort -V | head -n1 || true)"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Prepare tags
        id: tags
        run: |
          set -euo pipefail
          image="${{ steps.image.outputs.image }}"
          tags_list="${image}:latest"
          if [ -n "${{ steps.version.outputs.tag }}" ]; then
            tags_list="${tags_list}\n${image}:${{ steps.version.outputs.tag }}"
          fi
          {
            echo "tags<<EOF"
            printf "%b\n" "${tags_list}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
